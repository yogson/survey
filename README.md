# survey
# Руководство по использованию API

## Основные принципы

API руководствуется принципами REST. Запрос данных осуществляется при помощи GET, создание записи: POST, изменение: PUT и удаление:  DELETE.

## Аутентификация и права
Система разделяет пользователей на авторизованных и анонимных. Авторизованным считается лбой аутентифицированный пользователь.
Авторизованным пользователям доступен административный функционал системы: создание, редактирование, удаление сущностей.
Для некоторых видов сущностей реактирование и удаление посредством API недоступно в том числе и авторизованным пользователям.

Аутентификация осуществляется путём передачи имени пользователя и пароля в загаловке http-запроса (basic http auth).

## Структура API

Общий формат uri: /api/<точка входа>/<идентификатор>/

/api/ - единый префикс для всех запросов. Обратный слэш в конце строки uri - обязателен.

 API предоставляет несколько точек входа:
 ### /surveys/
Возвращает список опросов. Авторизованный позльзователь получает полный список опросов, анонимный - только активных на текущий момент.

При указании идентификатора возвращается информация о конкретном опросе.

Структура данных, представляющая опрос:
 
 `    {
          "id": 1,
          "title": "First survey",
          "description": "Yet another survey",
          "started_on": "2020-05-06",
          "finished_on": "2020-06-06",
          "questions": [
              2,
              3,
              4,
              1
          ]
      }`
      
Данные по ключу `questions` - список идентификаторов вопросов, вкючённых в данный опрос.
При создании и обновлении опроса производится проверка на их существование.

 ### /questions/
 Возвращает список вопросов.
 Структура данных, представляющая вопрос:
 
 `{
          "id": 3,
          "title": "Is Schrödinger's cat alive?",
          "type": "multi",
          "answer_options": [
              1,
              2
          ]
      }`
 
Строка по ключу `type` указывает на тип вопроса и может принимать 3 значения:
* `text` - открытый вопрос, ответом на который служит строка текста
* `one` - закрытый вопрос с выбором одного из списка вариантов ответа
* `multi` - закрытый вопрос с выбором одного или нескольких из списка вариантов ответа

Данные по ключу `answer_options` - список идентификаторов вариантов ответа на данный вопрос.
При создании и обновлении вопроса производится проверка на их существование.

 ### /options/
Возвращает список вариантов ответа. Варианты не привязаны к конкретному вопросу и могут быть использованы произвольно в любом их количестве.
Структура данных:

`{
         "id": 1,
         "option": "Yes"
     }`

`option` - текстовое поле, содержащее вариант ответа.

 ### /run/
 Точка входа для прохождения опросов.
 По GET-запросу возвращается список ответов на вопросы с указанием на опрос и условный числовой идентификатор пользователя, переданный при ответе.
 POST-запрос осуществляет функцию ответа на заданный вопрос.
 Структура данных:
 
 `{
          "id": 12,
          "user_id": 10,
          "survey": 1,
          "question": 1,
          "text": "",
          "selected": [
              1
          ]
      }`
      
 Где:
 * `user_id` - произвольный числовой идентификатор пользователя
 * `survey` - идентификатор опроса
 * `question` - идентификатор вопроса, на который производится ответ
 * `text` - ответ на вопрос, в случае, когда вопрос открытый
 * `selected` - список идентификаторов вариантов ответа, в случае, когда вопрос закрытый
 
 При публикации ответа производится проверка на валидность (существование) указанного опроса и вопроса, а также на соответсвия ответа типу вопроса (текст, один или несколько вариантов).
 После публикации ответа его изменение невозможно. Однако, возможно повторное участие в опросе с тем же идентиикатором пользователя.
 
 ### /result/<user_id>/
Точка входа для получения всех ответов конкретного пользователя по его идентификатору.
Структура данных представляет собой избыточную развёрнутую картину и позволяет избежать дополнительных запросов.

`    {
         "id": 7,
         "survey": 1,
         "question": {
             "id": 1,
             "title": "Is everything okey?!",
             "type": "one",
             "answer_options": [
                 {
                     "id": 1,
                     "option": "Yes"
                 },
                 {
                     "id": 2,
                     "option": "No"
                 }
             ]
         },
         "text": "",
         "selected": [
             {
                 "id": 1,
                 "option": "Yes"
             },
             {
                 "id": 2,
                 "option": "No"
             }
         ]
     }`
     

## Использование API

Рекомендуемый алгоритм создания опроса:
1) Спроектировать структуру вопросов и вариантов ответов
2) Создать варианты ответа
3) Создать вопросы
4) Создать опрос и указать все необходимые вопросы

Рекомендуемый алгоритм проведения опроса:
1) Получить список активных опросов, выбрать целевой: `/api/surveys/`
2) Получить список вопросов, выбрать те, что относятся к целевому опросу `/api/questions/`
3) Получить список вариантов ответов, если впросы включают в себя закрытые `/api/options/`
4) Вывести полученные данные пользователю
5) Передать ответы пользователя, назначив ему идентификатор `/api/run/`
6) Вернуть пользователю ошибки при их наличии